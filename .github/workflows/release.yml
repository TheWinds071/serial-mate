name: Release Builder

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-and-release:
    name: Build for ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            platform: windows/amd64
            artifact_name: serial-mate.exe
            asset_name: serial-mate-windows-amd64.exe
          # Ubuntu 22.04 with webkit 4.0 for better compatibility
          - os: ubuntu-22.04
            platform: linux/amd64
            artifact_name: serial-mate
            asset_name: serial-mate-linux-amd64
            distro: ubuntu-22.04
            nfpm_config: linux-webkit40.yaml
            webkit_version: "4.0"
          # Ubuntu 24.04 with webkit 4.1
          - os: ubuntu-24.04
            platform: linux/amd64
            artifact_name: serial-mate
            asset_name: serial-mate-linux-amd64
            distro: ubuntu-24.04
            nfpm_config: linux-webkit41.yaml
            webkit_version: "4.1"
          - os: macos-latest
            platform: darwin/universal
            artifact_name: serial-mate.app
            asset_name: serial-mate-macos-universal.app.zip

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: '0'

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          check-latest: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Wails
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      # Linux ä¾èµ–å®‰è£…æ­¥éª¤
      - name: Install Linux Dependencies (webkit 4.0)
        if: matrix.webkit_version == '4.0'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.0-dev

      - name: Install Linux Dependencies (webkit 4.1)
        if: matrix.webkit_version == '4.1'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev

      # Build Application
      # Note: Removed -tags webkit2gtk_4_1 due to pkg-config path issues in Wails v2.11.0
      # Wails will automatically detect the installed webkit2gtk version
      - name: Build Application
        shell: bash
        run: |
          wails build -platform ${{ matrix.platform }} -clean

      # å¤„ç† Windows äº§ç‰©
      - name: Prepare Windows Asset
        if: matrix.os == 'windows-latest'
        run: |
          cd build/bin
          mv ${{ matrix.artifact_name }} ../../${{ matrix.asset_name }}

      # å¤„ç† Linux äº§ç‰© - åˆ›å»ºåŒ…
      - name: Install nfpm
        if: matrix.distro != ''
        run: |
          echo "deb [trusted=yes] https://repo.goreleaser.com/apt/ /" | sudo tee /etc/apt/sources.list.d/goreleaser.list
          sudo apt-get update
          sudo apt-get install -y nfpm

      - name: Prepare Linux Packages
        if: matrix.distro != ''
        run: |
          # Extract version from git tag
          VERSION=${GITHUB_REF#refs/tags/v}
          export VERSION
          
          # Create .deb package using Makefile
          mkdir -p dist
          VERSION=$VERSION nfpm package --packager deb --config packaging/nfpm/${{ matrix.nfpm_config }} --target dist/
          
          # Rename with version and distro
          mv dist/serial-mate_${VERSION}_amd64.deb serial-mate-${VERSION}-${{ matrix.distro }}-amd64.deb

      - name: Prepare Linux Binary Asset
        if: matrix.distro != ''
        run: |
          cd build/bin
          mv ${{ matrix.artifact_name }} ../../${{ matrix.asset_name }}
      
      # Generate AUR package files (only for Ubuntu 24.04 build)
      - name: Prepare AUR Package
        if: matrix.distro == 'ubuntu-24.04'
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          mkdir -p dist/aur
          cp packaging/aur/PKGBUILD dist/aur/
          cp packaging/aur/PKGBUILD-git dist/aur/
          sed -i "s/pkgver=.*/pkgver=${VERSION}/" dist/aur/PKGBUILD
          
          # Calculate SHA256 for source tarball
          wget -q "https://github.com/TheWinds071/serial-mate/archive/v${VERSION}.tar.gz" -O "/tmp/serial-mate-${VERSION}.tar.gz"
          SHA256SUM=$(sha256sum "/tmp/serial-mate-${VERSION}.tar.gz" | awk '{print $1}')
          sed -i "s/sha256sums=.*/sha256sums=('${SHA256SUM}')/" dist/aur/PKGBUILD
          
          # Create archive for AUR files
          cd dist/aur
          tar -czf ../serial-mate-aur-${VERSION}.tar.gz PKGBUILD PKGBUILD-git
          cd ../..
          
          echo "AUR package files prepared for version ${VERSION}"

      # å¤„ç† macOS äº§ç‰© (æ‰“åŒ… .app)
      - name: Prepare macOS Asset
        if: matrix.os == 'macos-latest'
        run: |
          cd build/bin
          zip -r ../../${{ matrix.asset_name }} ${{ matrix.artifact_name }}

      # [æ–°å¢žæ­¥éª¤] ç”Ÿæˆ Changelog
      # è¿™ä¸ª Action ä¼šè¯»å– commit message å¹¶ç”Ÿæˆ markdown æ–‡æœ¬
      - name: Build Changelog
        id: build_changelog
        if: startsWith(github.ref, 'refs/tags/')
        uses: mikepenz/release-changelog-builder-action@v5
        with:
          configuration: |
            {
                "template": "#{{CHANGELOG}}",
                "categories": [
                  {
                    "title": "## ðŸš€ æ–°åŠŸèƒ½ (Features)",
                    "labels": ["feature", "feat", "enhancement"]
                  },
                  {
                    "title": "## ðŸ› Bug ä¿®å¤ (Fixes)",
                    "labels": ["fix", "bug"]
                  },
                  {
                    "title": "## ðŸ›  ä¼˜åŒ–ä¸Žç»´æŠ¤ (Maintenance)",
                    "labels": ["chore", "refactor", "docs", "documentation"]
                  },
                  {
                    "title": "## ðŸ“¦ ä¾èµ–æ›´æ–° (Dependencies)",
                    "labels": ["dependencies"]
                  }
                ],
                "ignore_unknown": false
            }
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # [ä¿®æ”¹æ­¥éª¤] ä¸Šä¼  Release
      - name: Create Release and Upload Assets
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            ${{ matrix.asset_name }}
            *.deb
            *.rpm
            dist/*.tar.gz
          draft: false
          prerelease: false
          # å…³é”®ä¿®æ”¹ï¼šå…³é—­è‡ªåŠ¨ç”Ÿæˆï¼Œä½¿ç”¨ä¸Šé¢ç”Ÿæˆçš„ body
          generate_release_notes: false
          body: ${{ steps.build_changelog.outputs.changelog }}

  build-fedora:
    name: Build for Fedora ${{ matrix.fedora_version }}
    runs-on: ubuntu-latest
    container:
      image: fedora:${{ matrix.fedora_version }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Fedora 40 uses webkit2gtk 4.0 (older stable version)
          - fedora_version: 40
            webkit_package: webkit2gtk4.0-devel
            nfpm_config: linux-webkit40.yaml
          # Fedora 41 uses webkit2gtk 4.1 (newer version with updated API)
          - fedora_version: 41
            webkit_package: webkit2gtk4.1-devel
            nfpm_config: linux-webkit41.yaml
    
    steps:
      - name: Install build dependencies
        run: |
          dnf install -y git golang nodejs npm gtk3-devel ${{ matrix.webkit_package }} gcc-c++ make tar gzip

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: '0'

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          check-latest: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Wails
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Add Go bin to PATH
        run: echo "$HOME/go/bin" >> $GITHUB_PATH

      - name: Build Application
        run: |
          $HOME/go/bin/wails build -platform linux/amd64 -clean

      - name: Install nfpm
        run: |
          dnf install -y wget
          wget -qO /tmp/nfpm.rpm https://github.com/goreleaser/nfpm/releases/download/v2.35.3/nfpm_2.35.3_linux_amd64.rpm
          dnf install -y /tmp/nfpm.rpm

      - name: Create RPM Package
        run: |
          # Extract version from git tag
          VERSION=${GITHUB_REF#refs/tags/v}
          export VERSION
          
          # Create .rpm package using Makefile structure
          mkdir -p dist
          VERSION=$VERSION nfpm package --packager rpm --config packaging/nfpm/${{ matrix.nfpm_config }} --target dist/
          
          # Rename with version and distro
          mv dist/serial-mate-${VERSION}.x86_64.rpm serial-mate-${VERSION}-fedora${{ matrix.fedora_version }}-amd64.rpm

      - name: Upload RPM to Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: '*.rpm'
          draft: false
          prerelease: false