name: Release Builder

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-and-release:
    name: Build for ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            platform: windows/amd64
            artifact_name: serial-mate.exe
            asset_name: serial-mate-windows-amd64.exe
          # ä¸ºäº†æ›´å¥½çš„å…¼å®¹æ€§(è®©æ„å»ºå‡ºçš„ç¨‹åºèƒ½åœ¨æ—§Linuxä¸Šè¿è¡Œ)ï¼Œ
          # å»ºè®® Linux ä½¿ç”¨ ubuntu-22.04 è€Œä¸æ˜¯ latest
          - os: ubuntu-22.04
            platform: linux/amd64
            artifact_name: serial-mate
            asset_name: serial-mate-linux-amd64
          - os: macos-latest
            platform: darwin/universal
            artifact_name: serial-mate.app
            asset_name: serial-mate-macos-universal.app.zip

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: '0'

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          check-latest: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Wails
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      # Linux ä¾èµ–å®‰è£…æ­¥éª¤ (å·²ä¿®å¤åŒ…å)
      - name: Install Linux Dependencies
        if: matrix.os == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          # æ³¨æ„ï¼šUbuntu 22.04 ä¾ç„¶ä½¿ç”¨ 4.0ï¼Œå…¼å®¹æ€§æ›´å¥½
          # å¦‚æœä½ ä¸€å®šè¦ç”¨ ubuntu-latest (24.04)ï¼Œè¯·æ”¹ä¸º libwebkit2gtk-4.1-dev
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.0-dev

      # æ‰§è¡Œæ„å»º (å·²ä¿®å¤ï¼šç§»é™¤äº† -buildmode productionï¼Œå¢åŠ äº† -clean)
      - name: Build Application
        run: |
          wails build -platform ${{ matrix.platform }} -clean

      # å¤„ç† Windows äº§ç‰©
      - name: Prepare Windows Asset
        if: matrix.os == 'windows-latest'
        run: |
          cd build/bin
          mv ${{ matrix.artifact_name }} ../../${{ matrix.asset_name }}

      # å¤„ç† Linux äº§ç‰©
      - name: Prepare Linux Asset
        if: matrix.os == 'ubuntu-22.04'
        run: |
          cd build/bin
          mv ${{ matrix.artifact_name }} ../../${{ matrix.asset_name }}

      # å¤„ç† macOS äº§ç‰© (æ‰“åŒ… .app)
      - name: Prepare macOS Asset
        if: matrix.os == 'macos-latest'
        run: |
          cd build/bin
          zip -r ../../${{ matrix.asset_name }} ${{ matrix.artifact_name }}

      # [æ–°å¢æ­¥éª¤] ç”Ÿæˆ Changelog
      # è¿™ä¸ª Action ä¼šè¯»å– commit message å¹¶ç”Ÿæˆ markdown æ–‡æœ¬
      - name: Build Changelog
        id: build_changelog
        if: startsWith(github.ref, 'refs/tags/')
        uses: mikepenz/release-changelog-builder-action@v5
        with:
          configuration: |
            {
                "template": "#{{CHANGELOG}}",
                "categories": [
                  {
                    "title": "## ğŸš€ æ–°åŠŸèƒ½ (Features)",
                    "labels": ["feature", "feat", "enhancement"]
                  },
                  {
                    "title": "## ğŸ› Bug ä¿®å¤ (Fixes)",
                    "labels": ["fix", "bug"]
                  },
                  {
                    "title": "## ğŸ›  ä¼˜åŒ–ä¸ç»´æŠ¤ (Maintenance)",
                    "labels": ["chore", "refactor", "docs", "documentation"]
                  },
                  {
                    "title": "## ğŸ“¦ ä¾èµ–æ›´æ–° (Dependencies)",
                    "labels": ["dependencies"]
                  }
                ],
                "ignore_unknown": false
            }
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # [ä¿®æ”¹æ­¥éª¤] ä¸Šä¼  Release
      - name: Create Release and Upload Assets
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: ${{ matrix.asset_name }}
          draft: false
          prerelease: false
          # å…³é”®ä¿®æ”¹ï¼šå…³é—­è‡ªåŠ¨ç”Ÿæˆï¼Œä½¿ç”¨ä¸Šé¢ç”Ÿæˆçš„ body
          generate_release_notes: false
          body: ${{ steps.build_changelog.outputs.changelog }}